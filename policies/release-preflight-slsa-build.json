{
    "id": "slsa-build-3",
    "meta": {
        "description": "Verifies an artifact to check if it was built in Chainguard's SLSA_BUILD_3 build system",
        "frameworks": [
            {
                "id": "SLSA",
                "name": "Supply-Chain Levels for Software Artifacts"
            }
        ]
    },
    "common": {
        "context": {
            "buildPoint": {
                "value": "git+ssh://github.com/puerco/demo-slsa-e2e@a9e4d2d2b783fb2ac129378e1a93e7c1ea1891a9"
            },
            "builderId": {
                "value": "https://github.com/puerco/demo-slsa-e2e/.github/workflows/release.yaml"
            },
            "buildType": {
                "value": "https://github.com/Attestations/GitHubActionsWorkflow@v1"
            }
        },
        "identities": [
            {
                "sigstore": {
                    "mode": "regexp",
                    "issuer": "https://token.actions.githubusercontent.com",
                    "identity": "https://github.com/[-a-z]+/demo-slsa-e2e/.github/workflows/release.yaml@refs/tags/v.+"
                }
            }
        ]
    },
    "policies": [
        {
            "id": "slsa-builder-id",
            "source": {
                "location": { "uri": "git+https://github.com/carabiner-dev/policies#slsa/slsa-builder-id.json" }
            },
            "meta": { "controls": [ { "framework": "SLSA", "class": "BUILD", "id": "3" } ] }
        },
        {
            "id": "slsa-build-type",
            "source": {
                "location": { "uri": "git+https://github.com/carabiner-dev/policies#slsa/slsa-build-type.json" }
            },
            "meta": { "controls": [ { "framework": "SLSA", "class": "BUILD", "id": "3" } ] }
        },
        {
            "id": "slsa-build-point",
            "source": {
                "location": { "uri": "git+https://github.com/carabiner-dev/policies#slsa/slsa-build-point.json" }
            },
            "meta": {
                "controls": [ { "framework": "SLSA", "class": "BUILD", "id": "3" } ],
                "enforce": "OFF"
            }
        },
        {
            "id": "slsa-source-level",
            "source": {
                "location": { "uri": "git+https://github.com/carabiner-dev/policies#vsa/slsa-source-level1.json" }
            },
            "context": {
                "buildPointRepo": {
                    "required": true,
                    "type": "string",
                    "default": "git+ssh://github.com/puerco/demo-slsa-e2e"
                },
                "builderImage": {
                    "required": true,
                    "type": "string",
                    "default": "cgr.dev/chainguard/go"
                }
            },
            "chain": [
                {
                    "predicate": {
                        "type": "https://slsa.dev/provenance/v1",
                        "selector": "has(predicates[0].data.buildDefinition) ? (has(predicates[0].data.buildDefinition.resolvedDependencies) ? (predicates[0].data.buildDefinition.resolvedDependencies.map(dep, dep.uri.startsWith(context.buildPointRepo + '@'), dep)[0]) : '' ) : ''"
                    }
                }
            ],
            "identities":[
                {
                    "sigstore": {
                        "issuer": "https://token.actions.githubusercontent.com",
                        "identity": "https://github.com/slsa-framework/source-actions/.github/workflows/compute_slsa_source.yml@refs/heads/main"
                    }
                }
            ],
            "meta": {
                "controls": [ { "framework": "SLSA", "class": "SOURCE", "id": "1" } ],
                "enforce": "ON"
            }
        },
        {
            "id": "slsa-builder-image",
            "source": {
                "location": { "uri": "git+https://github.com/carabiner-dev/policies#vsa/slsa-build-level3.json" }
            },
            "context": {
                "builderImage": {
                    "required": true,
                    "type": "string",
                    "default": "cgr.dev/chainguard/go"
                }
            },
            "chain": [
                {
                    "predicate": {
                        "type": "https://slsa.dev/provenance/v1",
                        "selector": "has(predicates[0].data.buildDefinition) ? (has(predicates[0].data.buildDefinition.resolvedDependencies) ? (predicates[0].data.buildDefinition.resolvedDependencies.map(dep, dep.uri.startsWith(context.builderImage + '@'), dep.uri)[0].substring(context.builderImage.size() + 1)) : '' ) : ''"
                    }
                }
            ],
            "identities":[
                {
                    "sigstore": {
                        "issuer": "https://token.actions.githubusercontent.com",
                        "identity": "https://github.com/slsa-framework/source-actions/.github/workflows/compute_slsa_source.yml@refs/heads/main"
                    }
                }
            ]
        }
    ]
}
